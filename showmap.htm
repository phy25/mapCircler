<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <meta charset="utf-8">
	<style type="text/css">
		html { height: 100% }
  		body { height: 100%; margin: 0px; padding: 0px }
  		#map_shantou { height: 100% }
	</style>

	<script type="text/javascript"
    		src="https://maps.google.com/maps/api/js?v=3.6&sensor=false&libraries=drawing">
	</script>

	
  <script type="text/javascript" src="jquery.min.js"></script>

	<script type="text/javascript">

/*以下函数计算多边形的中心点，调用方法：Polygon.getBounds().getCenter()*/
if (!google.maps.Polygon.prototype.getBounds) {
﻿  google.maps.Polygon.prototype.getBounds = function(latLng) {

﻿  ﻿  var bounds = new google.maps.LatLngBounds();
﻿  ﻿  var paths = this.getPaths();
﻿  ﻿  var path;
﻿  ﻿  
﻿  ﻿  for (var p = 0; p < paths.getLength(); p++) {
﻿  ﻿  ﻿  path = paths.getAt(p);
﻿  ﻿  ﻿  for (var i = 0; i < path.getLength(); i++) {
﻿  ﻿  ﻿  ﻿  bounds.extend(path.getAt(i));
﻿  ﻿  ﻿  }
﻿  ﻿  }

﻿  ﻿  return bounds;
﻿  }
}

// 将html编码
function htmlEncode(str) {
   var s = "";
   if (str.length == 0) return "";
   s = str.replace(/&/g, "&amp;");
   s = s.replace(/</g, "&lt;");
   s = s.replace(/>/g, "&gt;");  
   s = s.replace(/\'/g, "&#39;");
   s = s.replace(/\"/g, "&quot;");
   return s;
}

//查找指定多边形的位置，用zIndex作为键值 
function getzIndex(jsonObj,poly){
  for (var i = 0; i < jsonObj.area.length; i++) {
    if (poly.zIndex == jsonObj.area[i].zIndex) return i;
  }
  return null; 
}

/*https://chart.googleapis.com/chart?chst=d_text_outline&chld=000000|20|l|000000|_|粤东信息大厦  做为maker显示*/


var map, infoWindow;
var jsonObj, names, Blocks;


function initialize() {
// json data input first
    jsonObj = {
"mode":[{"strokeColor":"#FF0000", "strokeOpacity":0.8, "strokeWeight": 2, "fillColor":"#FF0000", "fillOpacity": 0.35}],

"area":[
{"paths": [{"Lat":23.355258,"Lng":116.710652},
           {"Lat":23.352138,"Lng":116.710639},
           {"Lat":23.352412,"Lng":116.716227},
           {"Lat":23.355317,"Lng":116.716077}],
 "mode":0,"info":"this is first","name":"粤东信息大厦","zIndex":0},

{"paths": [{"Lat":23.3657258,"Lng":116.710652},
           {"Lat":23.362138,"Lng":116.710639},
           {"Lat":23.362412,"Lng":116.716227}],
 "mode":0,"info":"this is second","name":"平东街","zIndex":0}
]};

  // Construct my map
  var latlng = new google.maps.LatLng(23.352564,116.712881);  //point of Shantou information mall
  var myOptions = {
      zoom: 16,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
  map = new google.maps.Map(document.getElementById("map_shantou"),myOptions);

  // drawing tools on the map，draw a new poly
  var drawingManager = new google.maps.drawing.DrawingManager({
    drawingMode: null,
    drawingControl: true,
    drawingControlOptions: {
      position: google.maps.ControlPosition.TOP_LEFT,
      drawingModes: [
      google.maps.drawing.OverlayType.POLYGON
      ]},
    polygonOptions:jsonObj.mode[0]
    });
  drawingManager.setMap(map);

  google.maps.event.addListener(drawingManager, 'polygoncomplete', function(poly) {
    drawingManager.setDrawingMode(null);
    poly.setEditable(true);
    var addWindow = new google.maps.InfoWindow({content: '<form id="item_add"><p><label for="item_name">名称</label> <input type="text" id="item_name" required="required" /></p><p><label for="item_meta">备注</label> <textarea id="item_meta" style="height:100px;width:300px;"></textarea></p><p><input type="submit" value="确定" id="item_add_submit" /></p></form>', position: poly.getBounds().getCenter()});

    google.maps.event.addListener(addWindow, 'closeclick', function(){
      poly.setMap(null);
      poly = null;
    });

    addWindow.open(map);
    $('#item_add').bind('submit', function(){
      if(!$('#item_name').val()){
        alert('请输入名称。');
        return false;
      }

      poly.setEditable(false);
      if (jsonObj.area.length == 0) { poly.zIndex = 0; }
      else { poly.zIndex = jsonObj.area[jsonObj.area.length-1].zIndex+1; };
      jsonObj.area.push({"paths":poly.path, "mode":0,"info":$('#item_meta').val(),"name":$('#item_name').val(), "zIndex":poly.zIndex});
      google.maps.event.addListener(poly, 'dblclick', editBlock);
      Blocks.push(poly);

      var image = 'https://chart.googleapis.com/chart?chst=d_text_outline&chld=000000|20|l|000000|_|'+$('#item_name').val();
      var nameMarker = new google.maps.Marker({
        position: poly.getBounds().getCenter(),
        map: map,
        icon: image
      });
      names.push(nameMarker);

      addWindow.close();
  	  return false;
    });

  });


// Construct the polygon
  // Note that we don't specify an array or arrays, but instead just
  // a simple array of LatLngs in the paths property
  names = [];
  Blocks = [];
  for (var j = 0; j < jsonObj.area.length; j++) { 
    var areaCoords=[];
    for (var i =0; i < jsonObj.area[j].paths.length; i++) {
      areaCoords.push(new google.maps.LatLng(jsonObj.area[j].paths[i].Lat,jsonObj.area[j].paths[i].Lng));
    }
    jsonObj.area[j].zIndex = j;     //initial zIndex,unique
    var Block = new google.maps.Polygon({
      paths: areaCoords,
      strokeColor: jsonObj.mode[jsonObj.area[j].mode].strokeColor,
      strokeOpacity: jsonObj.mode[jsonObj.area[j].mode].strokeOpacity,
      strokeWeight: jsonObj.mode[jsonObj.area[j].mode].strokeWeight,
      fillColor: jsonObj.mode[jsonObj.area[j].mode].fillColor,
      fillOpacity: jsonObj.mode[jsonObj.area[j].mode].fillOpactiy,
      zIndex:j
    });

    Block.setMap(map);
    Blocks.push(Block);
/*  显示名字在区域中心 */
    var image = 'https://chart.googleapis.com/chart?chst=d_text_outline&chld=000000|20|l|000000|_|'+jsonObj.area[j].name;
    var nameMarker = new google.maps.Marker({
      position: Block.getBounds().getCenter(),
      map: map,
      icon: image,
    });
    names.push(nameMarker);

 // Add a listener for the click event
    google.maps.event.addListener(Block, 'dblclick', editBlock);
  }

}




// modify the Block: set the poly editable, open info, when done, replace info or dele the poly
function editBlock(event) {
  event.stop();// 停止默认的放大行为的执行
//  var contentString = "<b>"+ jsonObj.area[this.zIndex].name +"</b><br />";
  
//  var inputControlDiv = document.createElement('div');
//  var inputControl = new InputControl(inputControlDiv, map);

//  inputControlDiv.index = 1;
//  map.controls[google.maps.ControlPosition.TOP_LEFT].push(inputControlDiv);

  var poly = this;
  var jsonObjindex = getzIndex(jsonObj,poly);
  poly.setEditable(true);

  var infoPos = new google.maps.LatLng(map.getBounds().getSouthWest().lat(),map.getBounds().getNorthEast().lng());
  var addWindow = new google.maps.InfoWindow({content: '<form id="item_add"><p><label for="item_name">名称</label> <input type="text" id="item_name" required="required" value="'+htmlEncode(jsonObj.area[jsonObjindex].name)+'" /></p><p><label for="item_meta">备注</label> <textarea id="item_meta" style="height:100px;width:300px;">'+htmlEncode(jsonObj.area[jsonObjindex].info)+'</textarea></p><p><input type="submit" value="确定" id="item_add_submit" /><button id="item_delete_submit">删除区块</button></p></form>', position: poly.getBounds().getCenter()});
  
  addWindow.open(map);
  
  google.maps.event.addListener(addWindow, 'closeclick', function(){
    poly.setEditable(false);
    poly = null;

    Blocks[jsonObjindex].setMap(map);
  });
  
  
  $('#item_add').bind('submit', function(){//modified
    if(!$('#item_name').val()){
      alert('请输入名称。');
      return false;
    }
    poly.setEditable(false); 

    jsonObj.area[jsonObjindex].path = poly.path;
    jsonObj.area[jsonObjindex].mode = 0;
    jsonObj.area[jsonObjindex].info = $('#item_meta').val();
    var Block = Blocks[jsonObjindex];
    Block = null;
    Blocks[jsonObjindex] = poly;

    if (jsonObj.area[jsonObjindex].name != $('#item_name').val()) {
      jsonObj.area[jsonObjindex].name = $('#item_name').val();
      names[jsonObjindex].setMap(null);
      var image = 'https://chart.googleapis.com/chart?chst=d_text_outline&chld=000000|20|l|000000|_|'+$('#item_name').val();
      var nameMarker = new google.maps.Marker({
        position: poly.getBounds().getCenter(),
        map: map,
        icon: image
      });
      names[jsonObjindex] = nameMarker;
    };
    addWindow.close();
    return false;
  });

  $('#item_delete_submit').bind('click', function() {
    poly.setMap(null);
    poly = null;
    Blocks.splice(jsonObjindex,jsonObjindex+1);

    jsonObj.area.splice(jsonObjindex,jsonObjindex+1);

    names[jsonObjindex].setMap(null);
    var nameMarker = names[jsonObjindex];
    nameMarker = null;
    names.splice(jsonObjindex,jsonObjindex+1);
  });
}

// add interative windows as controller
function InputControl(controlDiv, map) {

  // Set CSS styles for the DIV containing the control
  // Setting padding to 5 px will offset the control
  // from the edge of the map
  controlDiv.style.padding = '5px';

  // Set CSS for the control border
  var controlUI = document.createElement('div');
  controlUI.style.backgroundColor = 'white';
  controlUI.style.borderStyle = 'solid';
  controlUI.style.borderWidth = '2px';
  controlUI.style.cursor = 'pointer';
  controlUI.style.textAlign = 'center';
  controlUI.title = 'Modify para of the block';
  controlDiv.appendChild(controlUI);

  // Set CSS for the control interior
  var controlText = document.createElement('div');
  controlText.style.fontFamily = 'Arial,sans-serif';
  controlText.style.fontSize = '12px';
  controlText.style.paddingLeft = '4px';
  controlText.style.paddingRight = '4px';
  controlText.innerHTML = '<form id="item_add"><p><label for="item_name">名称</label> <input type="text" id="item_name" required="required" value="old" /></p><p><label for="item_meta">备注</label> <textarea id="item_meta" style="height:100px;width:300px;">"new"</textarea></p><p><input type="submit" value="确定" id="item_add_submit" /><button id="item_delete_submit">删除区块</button></p></form>';
  controlUI.appendChild(controlText);

  // Setup the click event listeners:
   $('#item_add').bind('submit', function(){//modified
    if(!$('#item_name').val()){
      alert('请输入名称。');
      return false;
    }
    poly.setEditable(false); 

    jsonObj.area[jsonObjindex].path = poly.path;
    jsonObj.area[jsonObjindex].mode = 0;
    jsonObj.area[jsonObjindex].info = $('#item_meta').val();
    jsonObj.area[jsonObjindex].name = $('#item_name').val();

    addWindow.close();
    return false;
  });

  $('#item_delete_submit').bind('click', function() {
    poly.setMap(null);
    jsonObj.area.splice(jsonObjindex,jsonObjindex+1);
  });
  google.maps.event.addDomListener(controlUI, 'click', function() {
    return 0;
  });

}


	</script>
</head>



<body onload="initialize()">
  <div id="map_shantou" style="width:100%; height:100%"></div>
  
</body>

</html>
