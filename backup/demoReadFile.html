<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="utf-8">
	<title>mapCircler</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="css/bootstrap.min.css" rel="stylesheet" media="screen" />
</head>

<body>
	<div class="container">
		<h1>mapCircler - 读写文件测试</h1>
		<p><a class="btn" id="inputFileBtn" href="javascript:void(0)">导入文件</a>
		<a class="btn" id="downloadFileBtn" href="javascript:void(0)">导出文件</a>

		<pre id="output" class="hide"></pre>
	</div>
</body>

	<script src="../js/jquery.min.js"></script>
	<script src="../js/jquery.json-2.4.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script>

var jsonObj = {test:[1,2,3], hi:'123'};

jQuery(function($){
	
	function readJSON(json){
		try //防止出错
		{
			jsonObj = jQuery.parseJSON(json);
		}
		catch(err){
			alert('文件不是有效的 JSON 文件。');
		}
		
		console && console.log(jsonObj);
	}

	function readFile(){
		if (!(window.File && window.FileReader && window.FileList)){
		// 如果不支持 HTML5 读取文件
			var text = prompt('请将文件内容粘贴到这里并按 Enter。','');
			if(text){
				$('#output').show().text(text);
				readJSON(text);
			}
		}else{
		// 使用 HTML5 方式读取
			var $f = $('<input type="file" />').css('display', 'none');		
			var change = function(e){ //当选择一个文件的时候（事件 onchange）
			var file = e.target.files[0]; // FileList object 是一个数组，这里只取第一项
			console && console.log(file);
	
			var reader = new FileReader();

			// 读取文件完成时执行 onLoad 事件，先设置事件
			reader.onload = function(e){
				if(e.target.readyState == 2){
					$('#output').show().text(e.target.result);//非必须
					readJSON(e.target.result);
				}else{ // 出错
					alert('读取文件时出错：'+ e.target.error);
				}
			};

			reader.readAsBinaryString(file);
		};
	
		$f.change(change).appendTo('body').click();
		}

	}

	// 绑定函数到按钮上
	$('#inputFileBtn').click(readFile);

});

// 读取文件部分 text = $.toJSON(jsonObj)
function saveFile(text, filename){	
	if($.browser.chrome){
		if(!filename) filename = prompt('请输入文件名');
		var $h = $('<div style="position:absolute;z-index:10;top:0;left:0;width:50px;height:30px;"></div>'), $a = $('<a />').attr('href', 'data:text/octet-stream,' + encodeURIComponent(text)).attr('download', filename+'.mcf').text('保存').click(function(){$h.remove();});
		$h.append($a);
		$h.appendTo('body');
		//download 属性定义下载的文件名
	}else{
		var $h = $('<div style="position:absolute;z-index:10;top:0;left:0;width:50px;height:30px;"><textarea style="width:40px;height:30px;"></textarea> <a href="javascript:void(0)">OK</a></div>');
		$h.find('a').click(function(){$h.remove();return false;});		
		$h.appendTo('body').find('textarea').text(text).focus();
	}
}

$('#downloadFileBtn').click(saveFile);
	</script>
</html>
